name: Test Nautilus Backup Extension

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
  release:
    types: [published]

jobs:
  # Quick syntax check (runs first, fastest)
  syntax-check:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Check Python syntax
      run: |
        python3 -m py_compile nautilus-backup.py
        echo "âœ“ Python syntax valid"
    
    - name: Verify shebang
      run: |
        head -1 nautilus-backup.py | grep -q "^#!/usr/bin/env python3"
        echo "âœ“ Shebang correct"

  # Version detection test (critical!)
  version-detection:
    name: Test Version Detection
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Test version detection logic
      run: |
        python3 << 'EOF'
        import re
        
        with open('nautilus-backup.py', 'r') as f:
            content = f.read()
        
        # Check for required patterns
        required = [
            (r'try:.*gi\.require_version.*Nautilus.*4\.0', "Nautilus 4.0 detection"),
            (r'except ValueError:.*gi\.require_version.*Nautilus.*3\.0', "Nautilus 3.0 fallback"),
            (r'NAUTILUS_VERSION\s*=\s*[34]', "Version assignment"),
            (r'if GTK_VERSION == 4:', "GTK version check"),
        ]
        
        all_found = True
        for pattern, desc in required:
            if re.search(pattern, content, re.DOTALL):
                print(f"âœ“ {desc}")
            else:
                print(f"âœ— {desc} MISSING")
                all_found = False
        
        if not all_found:
            exit(1)
        
        print("\nâœ“ Version detection code present")
        EOF

  # Test on Ubuntu 22.04 (GTK 4)
  test-ubuntu-22:
    name: Ubuntu 22.04 (GTK 4)
    runs-on: ubuntu-22.04
    needs: version-detection
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-4.0
    
    - name: Test imports
      run: |
        python3 << 'EOF'
        import sys
        print("Testing standard imports...")
        import os, shutil, tarfile, subprocess, threading, re, logging
        from datetime import datetime
        from pathlib import Path
        from urllib.parse import unquote, urlparse
        print("âœ“ All standard library imports work")
        
        try:
            from gi.repository import GObject, Gtk, Gio, GLib
            print("âœ“ GTK 4 imports work on Ubuntu 22.04")
        except ImportError as e:
            print(f"âš  GTK imports failed: {e}")
        EOF

  # Test on Ubuntu 20.04 (GTK 3) - CRITICAL TEST!
  test-ubuntu-20:
    name: Ubuntu 20.04 (GTK 3)
    runs-on: ubuntu-20.04
    needs: version-detection
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-gi python3-gi-cairo gir1.2-gtk-3.0
    
    - name: Test Python compatibility
      run: |
        python3 --version
        python3 -m py_compile nautilus-backup.py
        echo "âœ“ Compatible with Ubuntu 20.04 Python"
    
    - name: Test imports
      run: |
        python3 << 'EOF'
        print("Testing on Ubuntu 20.04...")
        import os, shutil, tarfile, subprocess
        print("âœ“ Standard imports work")
        
        try:
            from gi.repository import GObject, Gtk, Gio, GLib
            print("âœ“ GTK 3 imports work on Ubuntu 20.04")
        except ImportError as e:
            print(f"âš  GTK imports failed: {e}")
        EOF

  # Shellcheck for install scripts
  shellcheck:
    name: Shellcheck Scripts
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Run shellcheck
      run: |
        sudo apt-get install -y shellcheck
        shellcheck install.sh -e SC2181 || true
        shellcheck uninstall.sh -e SC2181 || true
        echo "âœ“ Shell scripts checked"

  # File structure check
  file-structure:
    name: Verify File Structure
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check required files
      run: |
        files=(
          "nautilus-backup.py"
          "install.sh"
          "uninstall.sh"
          "README.md"
          "LICENSE"
          ".gitignore"
          "CHANGELOG.md"
          "QUICKSTART.md"
        )
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ“ $file"
          else
            echo "âœ— $file MISSING"
            exit 1
          fi
        done
        
        echo "âœ“ All required files present"

  # Documentation check
  documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Verify documentation
      run: |
        for pattern in "Installation" "Usage" "Features"; do
          if grep -q "$pattern" README.md; then
            echo "âœ“ README contains: $pattern"
          else
            echo "âœ— README missing: $pattern"
          fi
        done

  # All tests passed
  all-tests-passed:
    name: âœ… All Tests Passed
    runs-on: ubuntu-latest
    needs: 
      - syntax-check
      - version-detection
      - test-ubuntu-22
      - test-ubuntu-20
      - shellcheck
      - file-structure
      - documentation
    
    steps:
    - name: Success
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   âœ… All Tests Passed Successfully!           â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ“ Syntax valid"
        echo "âœ“ Version detection working"
        echo "âœ“ Ubuntu 22.04 compatible"
        echo "âœ“ Ubuntu 20.04 compatible"
        echo "âœ“ Shell scripts valid"
        echo "âœ“ File structure correct"
        echo "âœ“ Documentation complete"
        echo ""
        echo "ðŸŽ‰ Ready for release!"